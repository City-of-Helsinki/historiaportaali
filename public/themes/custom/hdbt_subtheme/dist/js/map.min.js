(()=>{var e=Object.defineProperty;var t=(t,n)=>e(t,"name",{value:n,configurable:true});((e,Drupal,n)=>{let o;let s;let i=false;const{behaviors:r}=Drupal;r.map={attach(t){if(n("map","body").length){e(document).on("leafletMapInit",(t,n,r,a)=>{if(a.startsWith("leaflet-map-view-combined-map-block")){o=r;s=e(`#${a}`);const t=this.getUrlParameter("id");this.bindPopupPositioning();setTimeout(()=>{if(t)this.openPopupByNid(t);else this.applyZoomToView();if(i){i=false;s[0]?.focus({preventScroll:true})}},300)}})}this.bindFilterToggle(t);this.bindFilterForm(t)},bindFilterForm(t){e(document).on("submit",".node-type--map_page .views-exposed-form",()=>{this.announceFilterStatus("searching");i=true})},announceFilterStatus(t,n){const o=e("#map-filter-status");if(!o.length)return;if(t==="searching"){o.text(Drupal.t("Searching...",{},{context:"Map"}))}else if(t==="complete"){o.text(n===0?Drupal.t("Search complete. No items found.",{},{context:"Map"}):Drupal.t("Search complete. @count items found.",{"@count":n},{context:"Map"}))}},bindFilterToggle(t){const o=e(n("button",".exposed-filters .toggle-filters-btn",t));const s=e(".exposed-filters .exposed-filters__container",t);o.on("click",()=>{s.slideToggle(150);if(s.is(":visible")&&o.find("span.hds-icon").hasClass("hds-icon--angle-down")){o.find("span.hds-icon").removeClass("hds-icon--angle-down");o.find("span.hds-icon").addClass("hds-icon--angle-up")}else{o.find("span.hds-icon").removeClass("hds-icon--angle-up");o.find("span.hds-icon").addClass("hds-icon--angle-down")}})},openPopupByNid(e){if(!o||!s||!e){return}const t=s.data("leaflet");if(!t?.markers){return}const n=String(e);let i=t.markers[n];if(!i){const e=Object.keys(t.markers).find(e=>e.startsWith(`${n}-`));if(e){i=t.markers[e]}}if(!i){console.warn("Map: No marker found ID",n);console.info("Available marker IDs:",Object.keys(t.markers).map(e=>e.replace("-0","")));return}let r=false;o.eachLayer(e=>{if(e._group&&typeof e.getAllChildMarkers==="function"){if(e.getAllChildMarkers().includes(i)){r=true}}});this.zoomToLayer(i,r)},zoomToLayer(e,n=false){if(!e||!o){return false}if(n&&e.__parent?._group){e.__parent._group.zoomToShowLayer(e,()=>{e.openPopup()});return true}const s=t(()=>{e.openPopup();o.off("moveend",s)},"openPopupHandler");o.on("moveend",s);o.setView(e._latlng,15);return true},applyZoomToView(){if(!o||!s)return;const e=s.data("leaflet");if(!e)return;if(this.hasActiveFilters()){const t=Object.values(e.markers||{}).map(e=>e.getLatLng?.()||e._latlng).filter(Boolean);this.announceFilterStatus("complete",t.length);if(t.length===0)return;t.length===1?o.setView(t[0],15):o.fitBounds(L.latLngBounds(t),{padding:[20,20],maxZoom:18})}else if(e.map_settings?.center){const t=e.map_settings.center;o.setView(L.latLng(t.lat,t.lon),e.map_settings.zoom??14)}},hasActiveFilters(){const t=e(".node-type--map_page .views-exposed-form");const n=t.find('input[name="start_year"]').val()?.trim();const o=t.find('input[name="end_year"]').val()?.trim();const s=t.find('select[name="field_keywords_target_id"]').val();return!!(n||o||s&&s!=="All")},bindPopupPositioning(){let e=0;const n=t(e=>e.popup||e.target?._popup,"getPopup");const i=t(e=>n(e)?._source,"getMarker");o.on("popupopen",t=>{const s=n(t);const r=i(t);const a=r?.getElement?.();if(a)a.classList.add("active");const l=o.project(s._latlng);l.y-=s._container.clientHeight;o.panTo(o.unproject(l),{animate:true});this.updateUrlWithEntityId(r);e=window.scrollY});o.on("popupclose",e=>{const t=i(e);const n=t?.getElement?.();if(n){n.classList.remove("active");n.focus({preventScroll:true})}this.clearUrlEntityId()});document.addEventListener("keydown",e=>{if(e.key!=="Escape")return;if(s[0]?.querySelector(".leaflet-popup")&&o._popup){e.preventDefault();o.closePopup()}});document.addEventListener("focusin",t=>{const n=s[0]?.querySelector(".leaflet-popup");const o=s[0]?.contains(t.target);if(n?.contains(t.target))e=window.scrollY;else if(n&&!o)requestAnimationFrame(()=>window.scrollTo(0,e))},true)},updateUrlWithEntityId(e){if(!e||!s){return}const t=s.data("leaflet");if(!t?.markers){return}const n=Object.keys(t.markers).find(n=>t.markers[n]===e);if(n){const e=n.replace("-0","");const t=new URL(window.location);t.searchParams.set("id",e);window.history.replaceState({},"",t)}},clearUrlEntityId(){const e=new URL(window.location);e.searchParams.delete("id");window.history.replaceState({},"",e)},getUrlParameter(e){const t=window.location.search.substring(1);const n=t.split("&");let o;let s;for(s=0;s<n.length;s+=1){o=n[s].split("=");if(o[0]===e){return typeof o[1]==="undefined"?true:decodeURIComponent(o[1])}}return false}}})(jQuery,Drupal,once)})();