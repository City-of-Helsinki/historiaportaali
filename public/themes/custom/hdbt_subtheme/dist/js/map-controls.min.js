(()=>{var e=Object.defineProperty;var t=(t,o)=>e(t,"name",{value:o,configurable:true});((e,Drupal)=>{const{behaviors:o}=Drupal;o.mapControls={attach(){const o=this;if(typeof L==="undefined"||!L.Map){return}L.Map.addInitHook(function(){const n=this;if(this.options?.mapName==="comparison-map"){o.bindLayerControls(this,"comparison-map")}else{o.bindLayerControls(this,"main-map");o.bindZoomControls(this);o.bindLocateControl(this);this.removeControl(this.zoomControl)}e(".map-controls__map-layer").each(function(){const t=e(this);const o=t.attr("aria-label");t.select2({minimumResultsForSearch:Number.POSITIVE_INFINITY,placeholder(){return e(this).data("placeholder")},allowClear:true});t.on("select2:unselecting",()=>{t.data("map-controls-unselecting",true)});t.on("select2:opening",e=>{if(t.data("map-controls-unselecting")){t.removeData("map-controls-unselecting");e.preventDefault();setTimeout(()=>{t.select2("close");t.next(".select2-container").find(".select2-selection").trigger("blur")},0)}});const n=t.next(".select2-container").find(".select2-selection__rendered");n.attr({role:"combobox","aria-label":o,"aria-haspopup":"listbox","aria-expanded":"false"});t.on("select2:open",()=>{n.attr("aria-expanded","true")}).on("select2:close",()=>{n.attr("aria-expanded","false")});t.on("select2:select",r=>{n.attr("aria-label",`${o}: ${r.params.data.text}`);e(document).find(`.map-controls__clear-btn[data-clear-for="${t.attr("id")}"]`).prop("hidden",false).attr("aria-hidden","false")});t.on("select2:clear",()=>{n.attr("aria-label",o);e(document).find(`.map-controls__clear-btn[data-clear-for="${t.attr("id")}"]`).prop("hidden",true).attr("aria-hidden","true")})});e(".map-controls__map-layer").val("default").trigger("change.select2");e(".map-controls__map-layer").each((t,o)=>{const n=e(o);const r=e(document).find(`.map-controls__clear-btn[data-clear-for="${n.attr("id")}"]`);if(n.val()){r.prop("hidden",false).attr("aria-hidden","false")}else{r.prop("hidden",true).attr("aria-hidden","true")}});e(document).on("mousedown.mapcontrols click.mapcontrols",".map-controls__clear-btn",t=>{t.preventDefault();t.stopPropagation();if(t.type==="mousedown")return;const r=e(t.currentTarget);const a=r.data("clear-for");const i=e(`#${a}`);if(!i.length||!i.hasClass("map-controls__map-layer"))return;r.prop("hidden",true).attr("aria-hidden","true");requestAnimationFrame(()=>{i.data("map-controls-unselecting",true);i.val(null).trigger("change");o.removeOtherMapLayers(n,null)})});this.on("unload",function(){if(this.options?.mapName==="comparison-map"){o.unBindLayerControls("comparison-map")}else{o.unBindLayerControls("main-map")}});n.on("layeradd",e=>{if(e.layer instanceof L.Marker&&!(e.layer instanceof L.MarkerCluster)){const t=e.layer.getElement();if(t){t.setAttribute("tabindex","0");const o=e.layer.options?.title&&String(e.layer.options.title).trim()||Drupal.t("Map marker",{},{context:"Map controls"});t.removeAttribute("title");t.setAttribute("aria-label",o);t.addEventListener("keydown",t=>{if(t.key==="Enter"||t.key===" "){t.preventDefault();e.layer.openPopup()}})}}});n.on("layeradd",e=>{if(e.layer instanceof L.MarkerClusterGroup){const o=e.layer;const r=t(e=>{if(!e||!e.isConnected)return;e.setAttribute("tabindex","0");e.setAttribute("role","button");const t=e.querySelector("span")?.textContent?.trim()||"0";e.setAttribute("aria-label",Drupal.t("Cluster of @count markers",{"@count":t},{context:"Map controls"}))},"setClusterAccessibility");const a=n.getContainer();const i=t(()=>{a.querySelectorAll(".marker-cluster:not([aria-label])").forEach(r)},"ensureClusterAriaLabels");const s=new MutationObserver(()=>{i()});s.observe(a,{childList:true,subtree:true});i();setTimeout(i,100);const l=t((e,o)=>{if(!e||!o||typeof e.getVisibleParent!=="function")return null;const n=e._topClusterLevel;if(!n)return null;const r=t(e=>{if(e._icon===o)return e;if(e._childClusters){for(let t=0;t<e._childClusters.length;t+=1){const o=r(e._childClusters[t]);if(o)return o}}return null},"walk");return r(n)},"findClusterByIcon");const c=t(e=>{if(e.key!=="Enter"&&e.key!==" ")return;const t=e.target?.closest?.(".marker-cluster")||null;if(!t)return;e.preventDefault();const r=t.getBoundingClientRect();const i=a.getBoundingClientRect();const s=[r.left-i.left+r.width/2,r.top-i.top+r.height/2];const c=l(o,t);if(c&&typeof c.spiderfy==="function"){c.spiderfy()}else{const e=r.left+r.width/2;const o=r.top+r.height/2;for(const n of["mousedown","mouseup","click"]){const r=new MouseEvent(n,{bubbles:true,cancelable:true,view:window,clientX:e,clientY:o});t.dispatchEvent(r)}}setTimeout(()=>{const e=Array.from(a.querySelectorAll('.leaflet-marker-pane [tabindex="0"]')).filter(e=>!e.classList.contains("marker-cluster"));const t=e.map(e=>{const t=e.getBoundingClientRect();const o=t.left-i.left+t.width/2;const n=t.top-i.top+t.height/2;const r=t.width&&t.height?(o-s[0])**2+(n-s[1])**2:Number.POSITIVE_INFINITY;return{el:e,d:r}}).filter(e=>e.d<Number.POSITIVE_INFINITY).sort((e,t)=>e.d-t.d);if(t.length){t[0].el.focus();n._spiderfiedMarkerElements=t.map(e=>e.el)}},450)},"clusterKeydown");a.addEventListener("keydown",c,true);a.addEventListener("focusout",e=>{if(!a.contains(e.relatedTarget)){n._spiderfiedMarkerElements=null}})}});n.on("popupopen",e=>{const{popup:t}=e;const o=t.getElement();if(o){o.setAttribute("tabindex","0");const t=o.querySelector('.content-card__link, a, button, [tabindex="0"]');if(t){t.setAttribute("tabindex","0");t.focus()}else{o.focus()}n.panInside(e.popup.getLatLng(),{padding:[50,50]})}});n.on("popupclose",e=>{const t=e.popup._source;if(t){const e=t.getElement();if(e){e.focus()}}});n.on("keydown",e=>{if(e.key!=="Tab")return;const t=document.activeElement;const o=n._spiderfiedMarkerElements;const r=o?.indexOf(t);if(r>=0){if(!e.shiftKey&&r<o.length-1){e.preventDefault();o[r+1].focus()}else if(e.shiftKey&&r>0){e.preventDefault();o[r-1].focus()}else{n._spiderfiedMarkerElements=null}return}const a=Array.from(n.getLayers()).filter(e=>e instanceof L.Marker&&!(e instanceof L.MarkerCluster)).map(e=>e.getElement()).filter(Boolean);const i=a.indexOf(t);if(i===-1)return;e.preventDefault();const s=e.shiftKey?(i-1+a.length)%a.length:(i+1)%a.length;a[s].focus()});function r(t){if(t.key!=="Escape")return;const r=e("#geolocation-denied-overlay");if(r.length&&r.is(":visible")){t.preventDefault();o.hideGeolocationDeniedBox();return}if(document.querySelector(".leaflet-popup")){t.preventDefault();n.closePopup();return}if(n.getContainer().contains(document.activeElement)){t.preventDefault();const e=document.querySelector(".paragraph-content");if(e){if(e.tabIndex===-1)e.tabIndex=0;e.focus()}}}t(r,"escapeHandler");document.addEventListener("keydown",r);this.on("unload",()=>{document.removeEventListener("keydown",r)})})},bindLayerControls(t,o){const n=e(`.map-controls__map-layer.${o}`);n.change(o=>{const r=e(o.target);const a=r.find(":selected").not("[map-layer-title='default']").data("map-layer-title");const i=r.find(":selected").not("[map-layer-title='default']").data("map-api-endpoints");this.handleLayerSelection(t,a,i);t._mapControlsResettingOthers=true;n.not(o.target).each(function(){e(document).find(`.map-controls__clear-btn[data-clear-for="${e(this).attr("id")}"]`).prop("hidden",true).attr("aria-hidden","true")});n.not(o.target).val(null).trigger("change.select2");setTimeout(()=>{t._mapControlsResettingOthers=false},0)});n.on("select2:clear",()=>{if(t._mapControlsResettingOthers)return;this.removeOtherMapLayers(t,null)})},unBindLayerControls(t){const o=e(`.map-controls__map-layer.${t}`);o.off("click")},toggleLayerSelectorVisibility(t){const o=e(`.map-controls__map-layer.${t}`);if(o.is(".open")){o.removeClass("open")}else{o.addClass("open")}},handleLayerSelection(e,t,o){if(t==="present"){this.removeOtherMapLayers(e,null);return}if(o){for(const n of o){this.addMapLayer(e,n,t)}}},addMapLayer(e,t,o){const n=this.getMapApiUrl(t.map_api);this.showLoadingSpinner();const r=L.tileLayer.wms(n,{layers:t.wms_title,format:"image/png",transparent:true,className:o});r.addTo(e);r.on("load",()=>{this.removeOtherMapLayers(e,o);this.hideLoadingSpinner()})},removeOtherMapLayers(e,t){const o=Object.entries(e._layers).filter(([,e])=>e.wmsParams?.layers);let n;if(!t){n=o}else{n=o.filter(([,e])=>e.options.className!==t)}if(n.length){for(const e of n){e[1].remove()}}},getMapApiUrl(e){switch(e){case"kartta_hel_fi":return"https://kartta.hel.fi/ws/geoserver/avoindata/wms";default:return""}},showLoadingSpinner(){e("#map-loading-overlay").fadeIn(150)},hideLoadingSpinner(){e("#map-loading-overlay").fadeOut(150)},bindZoomControls(t){const o=e(".map-controls__control-button#zoom-in-btn");const n=e(".map-controls__control-button#zoom-out-btn");o.on("click",()=>{t.zoomIn()});n.on("click",()=>{t.zoomOut()})},bindLocateControl(t){const o=e(".map-controls__control-button#locate-btn");o.on("click",()=>{if(!navigator.geolocation){console.error("Geolocation is not supported by your browser")}else{this.showLoadingSpinner();navigator.geolocation.getCurrentPosition(e=>{this.hideLoadingSpinner();const o=e.coords.latitude;const n=e.coords.longitude;this.addUserLocationMarker(o,n,t);t.panTo([o,n]);t.setZoom(15)},e=>{if(e.code===1){this.showGeolocationDeniedBox()}this.hideLoadingSpinner()})}})},addUserLocationMarker(e,t,o){const n=new L.LatLng(e,t);const r=L.icon({iconSize:["36","36"],iconUrl:"/themes/custom/hdbt_subtheme/src/icons/user.svg"});const a=L.marker(n,{icon:r});a.addTo(o)},showGeolocationDeniedBox(){const t=Drupal.t("Location data blocked",{},{context:"Map controls"});const o=Drupal.t("You must allow your broser to use your location to see places near you.",{},{context:"Map controls"});const n=Drupal.t("Close");if(!e("#geolocation-denied-overlay").length){e(".leaflet-container").prepend('<div id="geolocation-denied-overlay" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="geolocation-denied-title" aria-describedby="geolocation-denied-desc"><div class="info-box"><div class="info-header"><span class="icon" aria-hidden="true"></span><h3 id="geolocation-denied-title"></h3><button type="button" class="close-btn"></button></div><p id="geolocation-denied-desc"></p></div></div>')}const r=e("#geolocation-denied-overlay");r.find("#geolocation-denied-title").text(t);r.find("#geolocation-denied-desc").text(o);r.find(".close-btn").text(n);r.off("click keydown").on("click",".close-btn",()=>{this.hideGeolocationDeniedBox()}).on("keydown",".close-btn",e=>{if(e.key==="Enter"||e.key===" "){e.preventDefault();this.hideGeolocationDeniedBox()}});e(document).off("keydown.geolocationDenied").on("keydown.geolocationDenied",t=>{if(t.key!=="Tab"||!r.is(":visible"))return;const o=r[0];const n=Array.from(o.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(e=>e.offsetParent);if(!n.length)return;const a=e.contains(o,t.target);const i=n.indexOf(document.activeElement);const s=n.length-1;if(!a||i===-1||(t.shiftKey?i<=0:i>=s)){t.preventDefault();n[t.shiftKey?s:0].focus()}});r.fadeIn(150,()=>{r.find(".close-btn")[0].focus()})},hideGeolocationDeniedBox(){e(document).off("keydown.geolocationDenied");e("#geolocation-denied-overlay").fadeOut(150)}}})(jQuery,Drupal)})();