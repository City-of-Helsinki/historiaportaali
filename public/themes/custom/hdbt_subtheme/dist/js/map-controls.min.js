(()=>{var e=Object.defineProperty;var t=(t,n)=>e(t,"name",{value:n,configurable:true});((e,Drupal,drupalSettings)=>{Drupal.behaviors.mapControls={attach:t(function(n,o){let i=this;if(typeof L==="undefined"||!L.Map){return}L.Map.addInitHook(function(){const n=this;if(this.options?.mapName=="comparison-map"){i.bindLayerControls(this,"comparison-map")}else{i.bindLayerControls(this,"main-map");i.bindZoomControls(this);i.bindLocateControl(this);this.removeControl(this.zoomControl)}e(".map-controls__map-layer").each(function(){const n=e(this);const o=n.attr("aria-label");n.select2({minimumResultsForSearch:Infinity,placeholder:t(function(){return e(this).data("placeholder")},"placeholder"),allowClear:true});n.on("select2:unselecting",function(){n.data("map-controls-unselecting",true)});n.on("select2:opening",function(e){if(n.data("map-controls-unselecting")){n.removeData("map-controls-unselecting");e.preventDefault();setTimeout(function(){n.select2("close");n.next(".select2-container").find(".select2-selection").trigger("blur")},0)}});const i=n.next(".select2-container").find(".select2-selection__rendered");i.attr({role:"combobox","aria-label":o,"aria-haspopup":"listbox","aria-expanded":"false"});n.on("select2:open",function(){i.attr("aria-expanded","true")}).on("select2:close",function(){i.attr("aria-expanded","false")});n.on("select2:select",function(t){i.attr("aria-label",`${o}: ${t.params.data.text}`);e(document).find('.map-controls__clear-btn[data-clear-for="'+n.attr("id")+'"]').prop("hidden",false).attr("aria-hidden","false")});n.on("select2:clear",function(){i.attr("aria-label",o);e(document).find('.map-controls__clear-btn[data-clear-for="'+n.attr("id")+'"]').prop("hidden",true).attr("aria-hidden","true")})});e(".map-controls__map-layer").val("default").trigger("change.select2");e(".map-controls__map-layer").each(function(){const t=e(this);const n=e(document).find('.map-controls__clear-btn[data-clear-for="'+t.attr("id")+'"]');if(t.val()){n.prop("hidden",false).attr("aria-hidden","false")}else{n.prop("hidden",true).attr("aria-hidden","true")}});e(document).on("mousedown.mapcontrols click.mapcontrols",".map-controls__clear-btn",function(t){t.preventDefault();t.stopPropagation();if(t.type==="mousedown")return;const o=e(this);const r=o.data("clear-for");const a=e("#"+r);if(!a.length||!a.hasClass("map-controls__map-layer"))return;o.prop("hidden",true).attr("aria-hidden","true");requestAnimationFrame(function(){a.data("map-controls-unselecting",true);a.val(null).trigger("change");i.removeOtherMapLayers(n,null)})});this.on("unload",function(){if(this.options?.mapName=="comparison-map"){i.unBindLayerControls("comparison-map")}else{i.unBindLayerControls("main-map")}});n.on("layeradd",function(e){if(e.layer instanceof L.Marker&&!(e.layer instanceof L.MarkerCluster)){const t=e.layer.getElement();if(t){t.setAttribute("tabindex","0");const n=e.layer.options?.title&&String(e.layer.options.title).trim()||Drupal.t("Map marker",{},{context:"Map controls"});t.removeAttribute("title");t.setAttribute("aria-label",n);t.addEventListener("keydown",function(t){if(t.key==="Enter"||t.key===" "){t.preventDefault();e.layer.openPopup()}})}}});n.on("layeradd",function(e){if(e.layer instanceof L.MarkerClusterGroup){let a=function(e){if(!e||!e.isConnected)return;e.setAttribute("tabindex","0");e.setAttribute("role","button");const t=e.querySelector("span")?.textContent?.trim()||"0";e.setAttribute("aria-label",Drupal.t("Cluster of @count markers",{"@count":t},{context:"Map controls"}))},l=function(){s.querySelectorAll(".marker-cluster:not([aria-label])").forEach(a)};var i=a,r=l;t(a,"setClusterAccessibility");t(l,"ensureClusterAriaLabels");const c=e.layer;const s=n.getContainer();const d=new MutationObserver(function(){l()});d.observe(s,{childList:true,subtree:true});l();setTimeout(l,100);const u=t(function(e){if(e.key!=="Enter"&&e.key!==" ")return;const t=e.target&&e.target.closest&&e.target.closest(".marker-cluster")||null;if(!t)return;e.preventDefault();const i=t.getBoundingClientRect();const r=s.getBoundingClientRect();const a=[i.left-r.left+i.width/2,i.top-r.top+i.height/2];const l=o(c,t);if(l&&typeof l.spiderfy==="function"){l.spiderfy()}else{const e=i.left+i.width/2;const n=i.top+i.height/2;["mousedown","mouseup","click"].forEach(function(o){const i=new MouseEvent(o,{bubbles:true,cancelable:true,view:window,clientX:e,clientY:n});t.dispatchEvent(i)})}setTimeout(function(){const e=Array.from(s.querySelectorAll('.leaflet-marker-pane [tabindex="0"]')).filter(function(e){return!e.classList.contains("marker-cluster")});const t=e.map(function(e){const t=e.getBoundingClientRect();const n=t.left-r.left+t.width/2;const o=t.top-r.top+t.height/2;const i=t.width&&t.height?(n-a[0])**2+(o-a[1])**2:Infinity;return{el:e,d:i}}).filter(function(e){return e.d<Infinity}).sort(function(e,t){return e.d-t.d});if(t.length){t[0].el.focus();n._spiderfiedMarkerElements=t.map(function(e){return e.el})}},450)},"clusterKeydown");s.addEventListener("keydown",u,true);s.addEventListener("focusout",function(e){if(!s.contains(e.relatedTarget)){n._spiderfiedMarkerElements=null}})}});function o(e,n){if(!e||!n||typeof e.getVisibleParent!=="function")return null;const o=e._topClusterLevel;if(!o)return null;function i(e){if(e._icon===n)return e;if(e._childClusters){for(let t=0;t<e._childClusters.length;t++){const n=i(e._childClusters[t]);if(n)return n}}return null}t(i,"walk");return i(o)}t(o,"findClusterByIcon");n.on("popupopen",function(e){const t=e.popup;const o=t.getElement();if(o){o.setAttribute("tabindex","0");const t=o.querySelector('.content-card__link, a, button, [tabindex="0"]');if(t){t.setAttribute("tabindex","0");t.focus()}else{o.focus()}n.panInside(e.popup.getLatLng(),{padding:[50,50]})}});n.on("popupclose",function(e){const t=e.popup._source;if(t){const e=t.getElement();if(e){e.focus()}}});n.on("keydown",function(e){if(e.key!=="Tab")return;const t=document.activeElement;const o=n._spiderfiedMarkerElements;const i=o&&o.indexOf(t);if(i>=0){if(!e.shiftKey&&i<o.length-1){e.preventDefault();o[i+1].focus()}else if(e.shiftKey&&i>0){e.preventDefault();o[i-1].focus()}else{n._spiderfiedMarkerElements=null}return}const r=Array.from(n.getLayers()).filter(function(e){return e instanceof L.Marker&&!(e instanceof L.MarkerCluster)}).map(function(e){return e.getElement()}).filter(Boolean);const a=r.indexOf(t);if(a===-1)return;e.preventDefault();const l=e.shiftKey?(a-1+r.length)%r.length:(a+1)%r.length;r[l].focus()});function r(t){if(t.key!=="Escape")return;const o=e("#geolocation-denied-overlay");if(o.length&&o.is(":visible")){t.preventDefault();i.hideGeolocationDeniedBox();return}if(document.querySelector(".leaflet-popup")){t.preventDefault();n.closePopup();return}if(n.getContainer().contains(document.activeElement)){t.preventDefault();const e=document.querySelector(".paragraph-content");if(e){if(e.tabIndex===-1)e.tabIndex=0;e.focus()}}}t(r,"escapeHandler");document.addEventListener("keydown",r);this.on("unload",function(){document.removeEventListener("keydown",r)})})},"attach"),bindLayerControls:t(function(t,n){let o=this;let i=e(`.map-controls__map-layer.${n}`);i.change(function(n){const r=e(n.target);const a=r.find(":selected").not("[map-layer-title='default']").data("map-layer-title");const l=r.find(":selected").not("[map-layer-title='default']").data("map-api-endpoints");o.handleLayerSelection(t,a,l);t._mapControlsResettingOthers=true;i.not(n.target).each(function(){e(document).find('.map-controls__clear-btn[data-clear-for="'+e(this).attr("id")+'"]').prop("hidden",true).attr("aria-hidden","true")});i.not(n.target).val(null).trigger("change.select2");setTimeout(function(){t._mapControlsResettingOthers=false},0)});i.on("select2:clear",function(){if(t._mapControlsResettingOthers)return;o.removeOtherMapLayers(t,null)})},"bindLayerControls"),unBindLayerControls:t(function(t){let n=e(`.map-controls__map-layer.${t}`);n.off("click")},"unBindLayerControls"),toggleLayerSelectorVisibility:t(function(t){let n=e(`.map-controls__map-layer.${t}`);if(n.is(".open")){n.removeClass("open")}else{n.addClass("open")}},"toggleLayerSelectorVisibility"),handleLayerSelection:t(function(e,t,n){let o=this;if(t=="present"){o.removeOtherMapLayers(e,null);return}if(n){n.forEach(n=>{o.addMapLayer(e,n,t)})}},"handleLayerSelection"),addMapLayer:t(function(e,t,n){let o=this;let i=o.getMapApiUrl(t.map_api);o.showLoadingSpinner();let r=L.tileLayer.wms(i,{layers:t.wms_title,format:"image/png",transparent:true,className:n});r.addTo(e);r.on("load",function(t){o.removeOtherMapLayers(e,n);o.hideLoadingSpinner()})},"addMapLayer"),removeOtherMapLayers:t(function(e,t){let n=Object.entries(e._layers).filter(([e,t])=>t.wmsParams?.layers);let o;if(!t){o=n}else{o=n.filter(([e,n])=>n.options.className!==t)}if(o.length){o.forEach(e=>e[1].remove())}},"removeOtherMapLayers"),getMapApiUrl:t(function(e){switch(e){case"kartta_hel_fi":return"https://kartta.hel.fi/ws/geoserver/avoindata/wms";default:return""}},"getMapApiUrl"),showLoadingSpinner:t(function(){e("#map-loading-overlay").fadeIn(150)},"showLoadingSpinner"),hideLoadingSpinner:t(function(){e("#map-loading-overlay").fadeOut(150)},"hideLoadingSpinner"),bindZoomControls:t(function(t){let n=e(".map-controls__control-button#zoom-in-btn");let o=e(".map-controls__control-button#zoom-out-btn");n.on("click",function(){t.zoomIn()});o.on("click",function(){t.zoomOut()})},"bindZoomControls"),bindLocateControl:t(function(t){let n=this;let o=e(".map-controls__control-button#locate-btn");o.on("click",function(){if(!navigator.geolocation){console.log("Geolocation is not supported by your browser")}else{n.showLoadingSpinner();navigator.geolocation.getCurrentPosition(e=>{n.hideLoadingSpinner();const o=e.coords.latitude;const i=e.coords.longitude;n.addUserLocationMarker(o,i,t);t.panTo([o,i]);t.setZoom(15)},e=>{if(e.code===1){n.showGeolocationDeniedBox()}n.hideLoadingSpinner()})}})},"bindLocateControl"),addUserLocationMarker:t(function(e,t,n){let o=new L.LatLng(e,t);let i=L.icon({iconSize:["36","36"],iconUrl:"/themes/custom/hdbt_subtheme/src/icons/user.svg"});let r=L.marker(o,{icon:i});r.addTo(n)},"addUserLocationMarker"),showGeolocationDeniedBox:t(function(){const t=this;const n=Drupal.t("Location data blocked",{},{context:"Map controls"});const o=Drupal.t("You must allow your broser to use your location to see places near you.",{},{context:"Map controls"});const i=Drupal.t("Close");if(!e("#geolocation-denied-overlay").length){e(".leaflet-container").prepend('<div id="geolocation-denied-overlay" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="geolocation-denied-title" aria-describedby="geolocation-denied-desc"><div class="info-box"><div class="info-header"><span class="icon" aria-hidden="true"></span><h3 id="geolocation-denied-title"></h3><button type="button" class="close-btn"></button></div><p id="geolocation-denied-desc"></p></div></div>')}const r=e("#geolocation-denied-overlay");r.find("#geolocation-denied-title").text(n);r.find("#geolocation-denied-desc").text(o);r.find(".close-btn").text(i);r.off("click keydown").on("click",".close-btn",function(){t.hideGeolocationDeniedBox()}).on("keydown",".close-btn",function(e){if(e.key==="Enter"||e.key===" "){e.preventDefault();t.hideGeolocationDeniedBox()}});e(document).off("keydown.geolocationDenied").on("keydown.geolocationDenied",function(t){if(t.key!=="Tab"||!r.is(":visible"))return;const n=r[0];const o=Array.from(n.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(function(e){return e.offsetParent});if(!o.length)return;const i=e.contains(n,t.target);const a=o.indexOf(document.activeElement);const l=o.length-1;if(!i||a===-1||(t.shiftKey?a<=0:a>=l)){t.preventDefault();o[t.shiftKey?l:0].focus()}});r.fadeIn(150,function(){r.find(".close-btn")[0].focus()})},"showGeolocationDeniedBox"),hideGeolocationDeniedBox:t(function(){e(document).off("keydown.geolocationDenied");e("#geolocation-denied-overlay").fadeOut(150)},"hideGeolocationDeniedBox")}})(jQuery,Drupal,drupalSettings)})();