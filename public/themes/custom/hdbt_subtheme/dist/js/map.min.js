(()=>{var e=Object.defineProperty;var t=(t,n)=>e(t,"name",{value:n,configurable:true});((e,Drupal,n)=>{let o;let i;const{behaviors:a}=Drupal;a.map={attach(t){if(n("map","body").length){e(document).on("leafletMapInit",(t,n,a,r)=>{if(r.startsWith("leaflet-map-view-combined-map-block")){o=a;i=e(`#${r}`);const t=this.getUrlParameter("id");this.bindPopupPositioning();setTimeout(()=>{if(t)this.openPopupByNid(t);else this.applyZoomToView()},300)}})}this.bindFilterToggle(t)},bindFilterToggle(t){const o=e(n("button",".exposed-filters .toggle-filters-btn",t));const i=e(".exposed-filters .exposed-filters__container",t);o.on("click",()=>{i.slideToggle(150);if(i.is(":visible")&&o.find("span.hds-icon").hasClass("hds-icon--angle-down")){o.find("span.hds-icon").removeClass("hds-icon--angle-down");o.find("span.hds-icon").addClass("hds-icon--angle-up")}else{o.find("span.hds-icon").removeClass("hds-icon--angle-up");o.find("span.hds-icon").addClass("hds-icon--angle-down")}})},openPopupByNid(e){if(!o||!i||!e){return}const t=i.data("leaflet");if(!t?.markers){return}const n=String(e);let a=t.markers[n];if(!a){const e=Object.keys(t.markers).find(e=>e.startsWith(`${n}-`));if(e){a=t.markers[e]}}if(!a){console.warn("Map: No marker found ID",n);console.info("Available marker IDs:",Object.keys(t.markers).map(e=>e.replace("-0","")));return}let r=false;o.eachLayer(e=>{if(e._group&&typeof e.getAllChildMarkers==="function"){if(e.getAllChildMarkers().includes(a)){r=true}}});this.zoomToLayer(a,r)},zoomToLayer(e,n=false){if(!e||!o){return false}if(n&&e.__parent?._group){e.__parent._group.zoomToShowLayer(e,()=>{e.openPopup()});return true}const i=t(()=>{e.openPopup();o.off("moveend",i)},"openPopupHandler");o.on("moveend",i);o.setView(e._latlng,15);return true},applyZoomToView(){if(!o||!i)return;const e=i.data("leaflet");if(!e)return;if(this.hasActiveFilters()){const t=Object.values(e.markers||{}).map(e=>e.getLatLng?.()||e._latlng).filter(Boolean);if(t.length===0)return;t.length===1?o.setView(t[0],15):o.fitBounds(L.latLngBounds(t),{padding:[20,20],maxZoom:18})}else if(e.map_settings?.center){const t=e.map_settings.center;o.setView(L.latLng(t.lat,t.lon),e.map_settings.zoom??14)}},hasActiveFilters(){const t=e(".node-type--map_page .views-exposed-form");const n=t.find('input[name="start_year"]').val()?.trim();const o=t.find('input[name="end_year"]').val()?.trim();const i=t.find('select[name="field_keywords_target_id"]').val();return!!(n||o||i&&i!=="All")},bindPopupPositioning(){o.on("popupopen",e=>{const t=o.project(e.target._popup._latlng);t.y-=e.target._popup._container.clientHeight;o.panTo(o.unproject(t),{animate:true});this.updateUrlWithEntityId(e.target._popup._source)});o.on("popupclose",()=>{this.clearUrlEntityId()})},updateUrlWithEntityId(e){if(!e||!i){return}const t=i.data("leaflet");if(!t?.markers){return}const n=Object.keys(t.markers).find(n=>t.markers[n]===e);if(n){const e=n.replace("-0","");const t=new URL(window.location);t.searchParams.set("id",e);window.history.replaceState({},"",t)}},clearUrlEntityId(){const e=new URL(window.location);e.searchParams.delete("id");window.history.replaceState({},"",e)},getUrlParameter(e){const t=window.location.search.substring(1);const n=t.split("&");let o;let i;for(i=0;i<n.length;i+=1){o=n[i].split("=");if(o[0]===e){return typeof o[1]==="undefined"?true:decodeURIComponent(o[1])}}return false}}})(jQuery,Drupal,once)})();