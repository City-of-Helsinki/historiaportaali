(()=>{var e=Object.defineProperty;var t=(t,n)=>e(t,"name",{value:n,configurable:true});((e,Drupal,drupalSettings)=>{Drupal.behaviors.mapControls={attach:t(function(n,o){let a=this;if(typeof L==="undefined"||!L.Map){return}L.Map.addInitHook(function(){const n=this;if(this.options?.mapName=="comparison-map"){a.bindLayerControls(this,"comparison-map")}else{a.bindLayerControls(this,"main-map");a.bindZoomControls(this);a.bindLocateControl(this);this.removeControl(this.zoomControl)}e(".map-controls__map-layer").each(function(){const n=e(this);const o=n.attr("aria-label");n.select2({minimumResultsForSearch:Infinity,placeholder:t(function(){return e(this).data("placeholder")},"placeholder"),allowClear:true});n.on("select2:unselecting",function(){n.data("map-controls-unselecting",true)});n.on("select2:opening",function(e){if(n.data("map-controls-unselecting")){n.removeData("map-controls-unselecting");e.preventDefault();setTimeout(function(){n.select2("close");n.next(".select2-container").find(".select2-selection").trigger("blur")},0)}});const a=n.next(".select2-container").find(".select2-selection__rendered");a.attr({role:"combobox","aria-label":o,"aria-haspopup":"listbox","aria-expanded":"false"});n.on("select2:open",function(){a.attr("aria-expanded","true")}).on("select2:close",function(){a.attr("aria-expanded","false")});n.on("select2:select",function(t){a.attr("aria-label",`${o}: ${t.params.data.text}`);e(document).find('.map-controls__clear-btn[data-clear-for="'+n.attr("id")+'"]').prop("hidden",false).attr("aria-hidden","false")});n.on("select2:clear",function(){a.attr("aria-label",o);e(document).find('.map-controls__clear-btn[data-clear-for="'+n.attr("id")+'"]').prop("hidden",true).attr("aria-hidden","true")})});e(".map-controls__map-layer").val("default").trigger("change.select2");e(".map-controls__map-layer").each(function(){const t=e(this);const n=e(document).find('.map-controls__clear-btn[data-clear-for="'+t.attr("id")+'"]');if(t.val()){n.prop("hidden",false).attr("aria-hidden","false")}else{n.prop("hidden",true).attr("aria-hidden","true")}});e(document).on("mousedown.mapcontrols click.mapcontrols",".map-controls__clear-btn",function(t){t.preventDefault();t.stopPropagation();if(t.type==="mousedown")return;const o=e(this);const r=o.data("clear-for");const i=e("#"+r);if(!i.length||!i.hasClass("map-controls__map-layer"))return;o.prop("hidden",true).attr("aria-hidden","true");requestAnimationFrame(function(){i.data("map-controls-unselecting",true);i.val(null).trigger("change");a.removeOtherMapLayers(n,null)})});this.on("unload",function(){if(this.options?.mapName=="comparison-map"){a.unBindLayerControls("comparison-map")}else{a.unBindLayerControls("main-map")}});n.on("layeradd",function(e){if(e.layer instanceof L.Marker&&!(e.layer instanceof L.MarkerCluster)){const t=e.layer.getElement();if(t){t.setAttribute("tabindex","0");const o=e.layer.options?.title&&String(e.layer.options.title).trim()||Drupal.t("Map marker",{},{context:"Map controls"});t.removeAttribute("title");t.setAttribute("aria-label",o);t.addEventListener("focus",function(){const t=e.layer;if(t){const e=n.latLngToContainerPoint(t.getLatLng());const o=n.getSize();const a=100;if(e.x<a||e.x>o.x-a||e.y<a||e.y>o.y-a){n.setView(t.getLatLng(),n.getZoom(),{animate:true,duration:.5,padding:[50,50]})}}});t.addEventListener("keydown",function(t){if(t.key==="Enter"||t.key===" "){t.preventDefault();e.layer.openPopup()}})}}});n.on("layeradd",function(e){if(e.layer instanceof L.MarkerClusterGroup){let i=function(e){if(!e||!e.isConnected)return;e.setAttribute("tabindex","0");e.setAttribute("role","button");const t=e.querySelector("span")?.textContent?.trim()||"0";e.setAttribute("aria-label",Drupal.t("Cluster of @count markers",{"@count":t},{context:"Map controls"}))},l=function(){c.querySelectorAll(".marker-cluster:not([aria-label])").forEach(i)};var a=i,r=l;t(i,"setClusterAccessibility");t(l,"ensureClusterAriaLabels");const s=e.layer;const c=n.getContainer();const u=new MutationObserver(function(){l()});u.observe(c,{childList:true,subtree:true});l();setTimeout(l,100);const d=t(function(e){if(e.key!=="Enter"&&e.key!==" ")return;const t=e.target&&e.target.closest&&e.target.closest(".marker-cluster")||null;if(!t)return;e.preventDefault();const a=t.getBoundingClientRect();const r=c.getBoundingClientRect();const i=[a.left-r.left+a.width/2,a.top-r.top+a.height/2];const l=o(s,t);if(l&&typeof l.spiderfy==="function"){l.spiderfy()}else{const e=a.left+a.width/2;const n=a.top+a.height/2;["mousedown","mouseup","click"].forEach(function(o){const a=new MouseEvent(o,{bubbles:true,cancelable:true,view:window,clientX:e,clientY:n});t.dispatchEvent(a)})}setTimeout(function(){const e=Array.from(c.querySelectorAll('.leaflet-marker-pane [tabindex="0"]')).filter(function(e){return!e.classList.contains("marker-cluster")});const t=e.map(function(e){const t=e.getBoundingClientRect();const n=t.left-r.left+t.width/2;const o=t.top-r.top+t.height/2;const a=t.width===0&&t.height===0?Infinity:Math.pow(n-i[0],2)+Math.pow(o-i[1],2);return{el:e,d:a}}).filter(function(e){return e.d<Infinity});t.sort(function(e,t){return e.d-t.d});const o=t.map(function(e){return e.el});if(o.length){o[0].focus();n._spiderfiedMarkerElements=o}},450)},"clusterKeydown");c.addEventListener("keydown",d,true);c.addEventListener("focusout",function(e){if(!c.contains(e.relatedTarget)){n._spiderfiedMarkerElements=null}})}});function o(e,n){if(!e||!n||typeof e.getVisibleParent!=="function")return null;const o=e._topClusterLevel;if(!o)return null;function a(e){if(e._icon===n)return e;if(e._childClusters){for(let t=0;t<e._childClusters.length;t++){const n=a(e._childClusters[t]);if(n)return n}}return null}t(a,"walk");return a(o)}t(o,"findClusterByIcon");n.on("popupopen",function(e){const t=e.popup;const o=t.getElement();if(o){o.setAttribute("tabindex","0");const t=o.querySelector('.content-card__link, a, button, [tabindex="0"]');if(t){t.setAttribute("tabindex","0");t.focus()}else{o.focus()}const a=n.latLngToContainerPoint(e.popup.getLatLng());const r=n.getSize();const i=100;if(a.x<i||a.x>r.x-i||a.y<i||a.y>r.y-i){n.setView(e.popup.getLatLng(),n.getZoom(),{animate:true,duration:.5,padding:[50,50]})}}});n.on("popupclose",function(e){const t=e.popup._source;if(t){const e=t.getElement();if(e){e.focus()}}});n.on("keydown",function(e){if(e.key==="Tab"){const t=document.activeElement;const o=n._spiderfiedMarkerElements;if(o&&o.length&&o.indexOf(t)!==-1){const a=o.indexOf(t);if(!e.shiftKey&&a<o.length-1){e.preventDefault();o[a+1].focus();return}if(e.shiftKey&&a>0){e.preventDefault();o[a-1].focus();return}n._spiderfiedMarkerElements=null;return}const a=Array.from(n.getLayers()).filter(e=>e instanceof L.Marker).map(e=>e.getElement()).filter(e=>e);const r=a.indexOf(t);if(r>-1){e.preventDefault();const t=e.shiftKey?r-1:r+1;const n=a[t>=a.length?0:t<0?a.length-1:t];n.focus()}}});const r=t(function(e){if(e.key==="Escape"){const t=document.querySelector(".leaflet-popup");if(t){e.preventDefault();n.closePopup()}else{const t=n.getContainer();const o=t.contains(document.activeElement);if(o){e.preventDefault();const t=document.querySelector(".paragraph-content");if(t){if(t.tabIndex===-1){t.tabIndex=0}t.focus()}}}}},"escapeHandler");document.addEventListener("keydown",r);this.on("unload",function(){document.removeEventListener("keydown",r)})})},"attach"),bindLayerControls:t(function(t,n){let o=this;let a=e(`.map-controls__map-layer.${n}`);a.change(function(n){let r=e(n.target).find(":selected").not("[map-layer-title='default']").data("map-layer-title");mapApiEndpoints=e(n.target).find(":selected").not("[map-layer-title='default']").data("map-api-endpoints");o.handleLayerSelection(t,r,mapApiEndpoints);t._mapControlsResettingOthers=true;a.not(n.target).each(function(){e(document).find('.map-controls__clear-btn[data-clear-for="'+e(this).attr("id")+'"]').prop("hidden",true).attr("aria-hidden","true")});a.not(n.target).val(null).trigger("change.select2");setTimeout(function(){t._mapControlsResettingOthers=false},0)});a.on("select2:clear",function(){if(t._mapControlsResettingOthers)return;o.removeOtherMapLayers(t,null)})},"bindLayerControls"),unBindLayerControls:t(function(t){let n=e(`.map-controls__map-layer.${t}`);n.off("click")},"unBindLayerControls"),toggleLayerSelectorVisibility:t(function(t){let n=e(`.map-controls__map-layer.${t}`);if(n.is(".open")){n.removeClass("open")}else{n.addClass("open")}},"toggleLayerSelectorVisibility"),handleLayerSelection:t(function(e,t,n){let o=this;if(t=="present"){o.removeOtherMapLayers(e,null);return}if(n){n.forEach(n=>{o.addMapLayer(e,n,t)})}},"handleLayerSelection"),addMapLayer:t(function(e,t,n){let o=this;let a=o.getMapApiUrl(t.map_api);o.showLoadingSpinner();let r=L.tileLayer.wms(a,{layers:t.wms_title,format:"image/png",transparent:true,className:n});r.addTo(e);r.on("load",function(t){o.removeOtherMapLayers(e,n);o.hideLoadingSpinner()})},"addMapLayer"),removeOtherMapLayers:t(function(e,t){let n=Object.entries(e._layers).filter(([e,t])=>t.wmsParams?.layers);let o;if(!t){o=n}else{o=n.filter(([e,n])=>n.options.className!==t)}if(o.length){o.forEach(e=>e[1].remove())}},"removeOtherMapLayers"),getMapApiUrl:t(function(e){switch(e){case"kartta_hel_fi":return"https://kartta.hel.fi/ws/geoserver/avoindata/wms";default:return""}},"getMapApiUrl"),showLoadingSpinner:t(function(){e("#map-loading-overlay").fadeIn(150)},"showLoadingSpinner"),hideLoadingSpinner:t(function(){e("#map-loading-overlay").fadeOut(150)},"hideLoadingSpinner"),bindZoomControls:t(function(t){let n=e(".map-controls__control-button#zoom-in-btn");let o=e(".map-controls__control-button#zoom-out-btn");n.on("click",function(){t.zoomIn()});o.on("click",function(){t.zoomOut()})},"bindZoomControls"),bindLocateControl:t(function(t){let n=this;let o=e(".map-controls__control-button#locate-btn");o.on("click",function(){if(!navigator.geolocation){console.log("Geolocation is not supported by your browser")}else{n.showLoadingSpinner();navigator.geolocation.getCurrentPosition(e=>{n.hideLoadingSpinner();const o=e.coords.latitude;const a=e.coords.longitude;n.addUserLocationMarker(o,a,t);t.panTo([o,a]);t.setZoom(15)},e=>{if(e.code===1){n.showGeolocationDeniedBox()}n.hideLoadingSpinner()})}})},"bindLocateControl"),addUserLocationMarker:t(function(e,t,n){let o=new L.LatLng(e,t);let a=L.icon({iconSize:["36","36"],iconUrl:"/themes/custom/hdbt_subtheme/src/icons/user.svg"});let r=L.marker(o,{icon:a});r.addTo(n)},"addUserLocationMarker"),showGeolocationDeniedBox:t(function(){let t=this;let n=Drupal.t("Location data blocked",{},{context:"Map controls"});let o=Drupal.t("Unfortunately, we are unable to show places on the map based on your location until you agree to use your location.",{},{context:"Map controls"});let a=Drupal.t("Close",{},{context:"Map controls"});e(".leaflet-container").prepend(`\n        <div id="geolocation-denied-overlay" style="display:none;">\n          <div class="info-box">\n            <div class="info-header">\n              <span class="info-icon"></span>\n              <h3>${n}</h3>\n              <div class="close-btn" role="button">${a}</div>\n            </div>\n            <p>${o}</p>\n          </div>\n        </div>\n      `);e("#geolocation-denied-overlay").fadeIn(150);e("#geolocation-denied-overlay .close-btn").on("click",function(){t.hideGeoloactionDeniedBox()});e(document).keyup(function(e){if(e.keyCode===27)t.hideGeoloactionDeniedBox()})},"showGeolocationDeniedBox"),hideGeoloactionDeniedBox:t(function(){e("#geolocation-denied-overlay").fadeOut(150)},"hideGeoloactionDeniedBox")}})(jQuery,Drupal,drupalSettings)})();